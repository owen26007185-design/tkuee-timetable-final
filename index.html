<style>
    /* ...åŸæœ‰æ¨£å¼... */
    .settings-group { margin-bottom: 15px; text-align: left; }
    .settings-group label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; font-weight: bold; }
    .read-only-box { background: #eee; padding: 10px; border-radius: 8px; font-size: 13px; color: #666; word-break: break-all; }
</style>

<div class="sidebar" id="sidebar">
    <h2 style="margin-top:0; color:var(--primary);">åŠŸèƒ½é¸å–®</h2>
    <div class="sidebar-item" onclick="showSection('timetable-section')">ğŸ  æˆ‘çš„èª²è¡¨é¦–é </div>
    <div class="sidebar-item" onclick="showSection('friends-section')">ğŸ‘¥ å¥½å‹åå–®</div>
    <div class="sidebar-item" onclick="showSection('requests-section')">ğŸ’Œ å¥½å‹è«‹æ±‚ <span id="req-count"></span></div>
    <div class="sidebar-item" onclick="showSection('explore-section')">ğŸŒ æ¢ç´¢/æœå°‹å¥½å‹</div>
    <div class="sidebar-item" onclick="showSection('settings-section')">âš™ï¸ å€‹äººè¨­å®š</div>
    <div class="sidebar-item" onclick="handleLogout()" style="color:#e74c3c; margin-top:30px;">ğŸšª ç™»å‡ºå¸³è™Ÿ</div>
</div>

<div id="main-app" style="display:none; width:100%;">
    <section id="settings-section" class="content-section">
        <div class="card">
            <h3 style="margin-top:0;">âš™ï¸ å€‹äººè¨­å®š</h3>
            
            <div class="settings-group">
                <label>å¥½å‹å”¯ä¸€ ID (åˆ†äº«çµ¦å¥½å‹ä»¥æ–°å¢)</label>
                <div id="display-uid" class="read-only-box">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="settings-group">
                <label>ç”¨æˆ¶åç¨±</label>
                <input type="text" id="set-username" placeholder="è«‹è¼¸å…¥æš±ç¨±">
            </div>

            <div class="settings-group">
                <label>é›»å­éƒµä»¶ (ä¸å¯æ›´æ”¹)</label>
                <div id="display-email" class="read-only-box">--</div>
            </div>

            <div class="settings-group">
                <label>å­¸æ ¡</label>
                <input type="text" id="set-school" placeholder="ä¾‹å¦‚ï¼šæ·¡æ±Ÿå¤§å­¸" value="æ·¡æ±Ÿå¤§å­¸">
            </div>

            <div class="settings-group">
                <label>å­¸è™Ÿ</label>
                <input type="text" id="set-student-id" placeholder="ä¾‹å¦‚ï¼š412xxxxxx">
            </div>

            <button class="primary-btn" style="background:#2ecc71;" onclick="updateProfile()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
    </section>
</div>

<script type="module">
    // ...Firebase åˆå§‹åŒ–...
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // å„²å­˜/æ›´æ–°å€‹äººè³‡æ–™
    window.updateProfile = async () => {
        if (!auth.currentUser) return;
        const profileData = {
            username: document.getElementById('set-username').value,
            school: document.getElementById('set-school').value,
            studentId: document.getElementById('set-student-id').value,
            email: auth.currentUser.email,
            uid: auth.currentUser.uid
        };

        try {
            // ä½¿ç”¨ merge: true ç¢ºä¿ä¸æœƒè¦†è“‹æ‰èª²è¡¨è³‡æ–™
            await setDoc(doc(db, "schedules", auth.currentUser.email), {
                profile: profileData
            }, { merge: true });
            alert("âœ… å€‹äººè¨­å®šå·²æ›´æ–°ï¼");
        } catch (e) {
            alert("æ›´æ–°å¤±æ•—: " + e.message);
        }
    };

    // ç™»å…¥å¾Œè¼‰å…¥è³‡æ–™
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // é¡¯ç¤ºè®€å–ä¸­çš„è³‡è¨Š
            document.getElementById('display-uid').innerText = user.uid;
            document.getElementById('display-email').innerText = user.email;

            const docSnap = await getDoc(doc(db, "schedules", user.email));
            if (docSnap.exists()) {
                const data = docSnap.data();
                // å¡«å…¥å·²æœ‰çš„è¨­å®šæª”
                if (data.profile) {
                    document.getElementById('set-username').value = data.profile.username || "";
                    document.getElementById('set-school').value = data.profile.school || "æ·¡æ±Ÿå¤§å­¸";
                    document.getElementById('set-student-id').value = data.profile.studentId || "";
                }
            }
        }
    });
</script>

