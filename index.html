<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª²è¡¨ App</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#2c3e50">

    <style>
        /* æ•´é«”æ¼¸å±¤èƒŒæ™¯ */
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); 
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
        }

        /* ç™»å…¥å¡ç‰‡ç¾åŒ– */
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            width: 100%; 
            max-width: 400px; 
            box-sizing: border-box;
            transition: 0.3s;
        }

        /* ç™»å…¥ä»‹é¢å°ˆå±¬æ¨£å¼ */
        .auth-header { text-align: center; margin-bottom: 20px; }
        .auth-logo { width: 80px; height: 80px; border-radius: 18px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .auth-title { color: #2c3e50; font-size: 22px; font-weight: bold; margin: 0; }
        .auth-subtitle { color: #7f8c8d; font-size: 13px; margin-top: 5px; }

        /* è¼¸å…¥æ¡†å‡ç´š */
        input { 
            width: 100%; 
            padding: 12px 15px; 
            margin: 10px 0; 
            border: 1px solid #dfe6e9; 
            border-radius: 10px; 
            font-size: 15px; 
            box-sizing: border-box;
            background: #f8f9fa;
        }
        input:focus { outline: none; border-color: #3498db; background: white; }

        /* æŒ‰éˆ•ç¾åŒ– */
        button { border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .primary-btn { background: #3498db; color: white; padding: 12px; font-size: 16px; }
        .primary-btn:active { transform: scale(0.98); background: #2980b9; }
        .secondary-btn { background: #f1f2f6; color: #7f8c8d; padding: 10px; font-size: 14px; }

        /* å…§å®¹å€å¡Šèˆ‡è¡¨æ ¼ */
        #main-app { display: none; width: 100%; max-width: 500px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 10px 2px; text-align: center; font-size: 13px; }
        th { background: #34495e; color: white; font-size: 14px; }
        .highlight-now { background: #fff3cd !important; border: 2px solid #ffc107 !important; }

        /* èª²ç¨‹é¡è‰² */
        .type-req { border-left: 4px solid #ef5350; background: #fff5f5; }
        .type-ele { border-left: 4px solid #42a5f5; background: #f0f7ff; }
        .type-lab { border-left: 4px solid #66bb6a; background: #f2f9f2; }
    </style>
</head>
<body>

    <div class="card" id="auth-section">
        <div class="auth-header">
            <img src="icon.png" class="auth-logo" alt="Logo">
            <div class="auth-title">æ·¡æ±Ÿé›»æ©Ÿèª²è¡¨</div>
            <div class="auth-subtitle">å·¥ç¨‹å¤§æ¨“å­¸ç”Ÿå°ˆç”¨å·¥å…·</div>
        </div>
        
        <input type="email" id="email" placeholder="å­¸æ ¡ Email (å¸³è™Ÿ)">
        <input type="password" id="pw" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½æ•¸)">
        
        <button class="primary-btn" style="width: 100%; margin-top: 10px;" onclick="handleAuth('login')">ç«‹åˆ»ç™»å…¥</button>
        
        <div style="display: flex; align-items: center; margin: 20px 0;">
            <div style="flex:1; height:1px; background:#eee;"></div>
            <div style="margin:0 10px; color:#bdc3c7; font-size:12px;">æ–°åŒå­¸ï¼Ÿ</div>
            <div style="flex:1; height:1px; background:#eee;"></div>
        </div>
        
        <button class="secondary-btn" style="width: 100%;" onclick="handleAuth('signup')">è¨»å†Šæ–°å¸³è™Ÿ</button>
    </div>

    <div id="main-app">
        <div class="card" style="background: rgba(255,255,255,0.9); padding: 15px;">
            <div id="user-info" style="font-size:12px; color:#2c3e50; font-weight:bold; text-align:center;"></div>
        </div>

        <div class="card" style="padding: 5px;">
            <table id="main-table">
                <thead>
                    <tr><th style="width: 45px;">ç¯€æ¬¡</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>
                </thead>
                <tbody id="timetable-body">
                    <script>
                        // ... å‹•æ…‹è¡¨æ ¼ç”Ÿæˆä»£ç¢¼ ...
                        const tbody = document.getElementById('timetable-body');
                        const times = ["08:10", "09:10", "10:10", "11:10", "12:10", "13:10", "14:10", "15:10", "16:10", "17:10"];
                        for(let i=1; i<=10; i++) {
                            let label = i; let time = times[i-1];
                            if(i === 5) { label = "ä¼‘"; time = "åˆä¼‘"; } else if (i > 5) { label = i - 1; }
                            let cells = "";
                            for(let day=1; day<=5; day++) {
                                cells += `<td onclick="cycleColor(this)" data-type="none"><div class="course-name" contenteditable="true"></div><div style="font-size:8px; color:#999;" contenteditable="true"></div></td>`;
                            }
                            tbody.innerHTML += `<tr data-row="${i}"><td style="background:#f8f9fa; font-weight:bold;">${label}<span style="font-size:8px; color:#999; display:block;">${time}</span></td>${cells}</tr>`;
                        }
                    </script>
                </tbody>
            </table>
            <button class="success-btn" style="width:100%; border-radius:12px; padding:15px; margin-top:10px;" onclick="saveToCloud()">ğŸ’¾ åŒæ­¥é›²ç«¯èª²è¡¨</button>
        </div>

        <button style="background:none; color:white; opacity:0.6; font-size:12px; width:100%; margin-bottom:30px;" onclick="handleLogout()">ç™»å‡ºå¸³è™Ÿ</button>
    </div>

    <script type="module">
        // ... Firebase é‚è¼¯ä»£ç¢¼ (ä¿æŒä¸è®Š) ...
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYw7X6OOlPrZRFlBuglb6i1MMvNdkyH1k",
            authDomain: "tkuee-timetable.firebaseapp.com",
            projectId: "tkuee-timetable",
            storageBucket: "tkuee-timetable.firebasestorage.app",
            messagingSenderId: "12075058527",
            appId: "1:12075058527:web:c6a3f9e99a6f7e75bb22ea"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            const authSection = document.getElementById('auth-section');
            const mainApp = document.getElementById('main-app');
            if (user) {
                authSection.style.display = 'none';
                mainApp.style.display = 'block';
                document.getElementById('user-info').innerText = "ğŸ‘¤ " + user.email;
                const docSnap = await getDoc(doc(db, "schedules", user.email));
                if (docSnap.exists() && docSnap.data().v6_data) {
                    const cells = document.querySelectorAll('#timetable-body td[data-type]');
                    docSnap.data().v6_data.forEach((item, idx) => {
                        if (cells[idx]) {
                            cells[idx].querySelector('.course-name').innerText = item.c || "";
                            cells[idx].querySelectorAll('div')[1].innerText = item.r || "";
                            cells[idx].setAttribute('data-type', item.t || "none");
                            cells[idx].className = 'type-' + (item.t || "none");
                        }
                    });
                }
            } else {
                authSection.style.display = 'block';
                mainApp.style.display = 'none';
            }
        });

        window.handleAuth = async (type) => {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('pw').value;
            if(!email || !pw) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
            try {
                if(type === 'signup') await createUserWithEmailAndPassword(auth, email, pw);
                else await signInWithEmailAndPassword(auth, email, pw);
            } catch(e) { alert("ç™»å…¥å¤±æ•—: " + e.message); }
        };

        window.handleLogout = () => signOut(auth).then(() => location.reload());
        window.saveToCloud = async () => { /* åŒå‰å„²å­˜é‚è¼¯ */ };
        window.cycleColor = (el) => { /* åŒå‰æ›è‰²é‚è¼¯ */ };
    </script>
</body>
</html>

