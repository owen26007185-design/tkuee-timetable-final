<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª²è¡¨ App</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#34495e">

    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        input { width: 85%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .primary-btn { background: #3498db; color: white; }
        .success-btn { background: #2ecc71; color: white; width: 100%; margin-top: 15px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 10px 5px; text-align: center; font-size: 14px; word-break: break-all; }
        th { background: #34495e; color: white; }
        .user-label { font-size: 14px; color: #7f8c8d; margin-top: 5px; font-weight: bold; }
        .time-label { font-size: 10px; color: #95a5a6; display: block; margin-top: 2px; }
        .lunch-row { background: #fff9e6 !important; color: #d35400; font-weight: bold; font-size: 12px; }

        /* å¿«æ·é€£çµç¶²æ ¼æ¨£å¼ */
        .link-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .link-btn { background: #ecf0f1; color: #2c3e50; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-size: 13px; font-weight: bold; border: 1px solid #dcdde1; }
        .link-btn:active { background: #dcdde1; }
    </style>
</head>
<body>

    <h2 style="color: #2c3e50;">å€‹äººèª²è¡¨</h2>

    <div class="card" id="auth-section">
        <h3 style="margin-top:0">ğŸ” å¸³è™Ÿç™»å…¥/è¨»å†Š</h3>
        <input type="email" id="email" placeholder="Email (å¸³è™Ÿ)">
        <input type="password" id="pw" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)">
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="primary-btn" style="flex:1" onclick="handleAuth('login')">ç™»å…¥</button>
            <button style="flex:1; background: #95a5a6; color: white;" onclick="handleAuth('signup')">è¨»å†Š</button>
        </div>
        <p id="user-info" class="user-label">ç‹€æ…‹ï¼šå°šæœªç™»å…¥</p>
        <button id="logout-btn" style="display:none; width: 100%; background: #e74c3c; color: white; margin-top: 10px;" onclick="handleLogout()">ç™»å‡ºå¸³è™Ÿ</button>
    </div>

    <div class="card">
        <h3 style="margin-top:0">ğŸ” æœå°‹åŒå­¸èª²è¡¨</h3>
        <div style="display: flex; gap: 8px;">
            <input type="email" id="search-email" placeholder="è¼¸å…¥åŒå­¸çš„ Email" style="flex:1; margin:0">
            <button class="primary-btn" onclick="searchFriend()">æœå°‹</button>
        </div>
    </div>

    <div class="card" style="max-width: 100%; overflow-x: auto; padding: 10px 5px;">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">ç¯€æ¬¡</th><th>é€±ä¸€</th><th>é€±äºŒ</th><th>é€±ä¸‰</th><th>é€±å››</th><th>é€±äº”</th>
                </tr>
            </thead>
            <tbody id="timetable-body">
                <script>
                    const tbody = document.getElementById('timetable-body');
                    const times = ["08:10", "09:10", "10:10", "11:10", "12:10", "13:10", "14:10", "15:10", "16:10", "17:10"];
                    for(let i=1; i<=10; i++) {
                        let label = i;
                        let time = times[i-1];
                        let rowClass = "";
                        if(i === 5) {
                            label = "åƒé£¯"; time = "åˆä¼‘"; rowClass = 'class="lunch-row"';
                        } else if (i > 5) { label = i - 1; }
                        tbody.innerHTML += `<tr ${rowClass}><td style="background:#f9f9f9"><b>${label}</b><span class="time-label">${time}</span></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>`;
                    }
                </script>
            </tbody>
        </table>
        <button class="success-btn" onclick="saveToCloud()">ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯</button>
    </div>

    <div class="card">
        <h3 style="margin-top:0">ğŸ”— æ ¡åœ’å¿«æ·é€£çµ</h3>
        <div class="link-grid">
            <a href="https://iclass.tku.edu.tw/" target="_blank" class="link-btn">æ·¡æ±Ÿ iClass</a>
            <a href="https://portal.tku.edu.tw/" target="_blank" class="link-btn">å€‹äººè³‡è¨Šç³»çµ±</a>
            <a href="https://www.ais.tku.edu.tw/elecos/" target="_blank" class="link-btn">é¸èª²ç³»çµ±</a>
            <a href="http://www.ee.tku.edu.tw/" target="_blank" class="link-btn">é›»æ©Ÿç³»å®˜ç¶²</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYw7X6OOlPrZRFlBuglb6i1MMvNdkyH1k",
            authDomain: "tkuee-timetable.firebaseapp.com",
            projectId: "tkuee-timetable",
            storageBucket: "tkuee-timetable.firebasestorage.app",
            messagingSenderId: "12075058527",
            appId: "1:12075058527:web:c6a3f9e99a6f7e75bb22ea"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const fillTable = (dataArray) => {
            const cells = document.querySelectorAll('#timetable-body td[contenteditable="true"]');
            dataArray.forEach((text, index) => { if (cells[index]) cells[index].innerText = text || ""; });
        };

        window.handleAuth = async (type) => {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('pw').value;
            if (!email || !pw) return alert("è«‹è¼¸å…¥å®Œæ•´å¸³è™Ÿå¯†ç¢¼");
            try {
                if (type === 'signup') { await createUserWithEmailAndPassword(auth, email, pw); alert("è¨»å†ŠæˆåŠŸï¼"); }
                else { await signInWithEmailAndPassword(auth, email, pw); alert("ç™»å…¥æˆåŠŸï¼"); }
            } catch (e) { alert("é©—è­‰éŒ¯èª¤: " + e.message); }
        };

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            const info = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');
            if (user) {
                info.innerText = "ç›®å‰ç™»å…¥: " + user.email;
                info.style.color = "#2ecc71";
                logoutBtn.style.display = "block";
                const docSnap = await getDoc(doc(db, "schedules", user.email));
                if (docSnap.exists() && docSnap.data().cells) { fillTable(docSnap.data().cells); }
            }
        });

        window.saveToCloud = async () => {
            if (!auth.currentUser) return alert("è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜ï¼");
            const cells = document.querySelectorAll('#timetable-body td[contenteditable="true"]');
            const cellTexts = Array.from(cells).map(td => td.innerText);
            try {
                await setDoc(doc(db, "schedules", auth.currentUser.email), { cells: cellTexts, updatedAt: new Date() });
                alert("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼å¿«æ·é€£çµå·²å•Ÿç”¨ã€‚");
            } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
        };

        window.searchFriend = async () => {
            const friendEmail = document.getElementById('search-email').value;
            if (!friendEmail) return alert("è«‹è¼¸å…¥ Email");
            try {
                const docSnap = await getDoc(doc(db, "schedules", friendEmail));
                if (docSnap.exists() && docSnap.data().cells) { fillTable(docSnap.data().cells); alert("ğŸ” å·²é¡¯ç¤º " + friendEmail + " çš„èª²è¡¨"); }
                else { alert("æ‰¾ä¸åˆ°è©²èª²è¡¨ã€‚"); }
            } catch (e) { alert("æœå°‹å¤±æ•—: " + e.message); }
        };
    </script>
</body>
</html>

