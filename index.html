<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·¡æ±Ÿé›»æ©Ÿèª²è¡¨ App</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* é€™è£¡ä¿ç•™ä½ åŸæœ¬çš„ CSS æ¨£å¼ */
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        input { width: 80%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .primary-btn { background: #3498db; color: white; }
        .success-btn { background: #2ecc71; color: white; width: 100%; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background: #34495e; color: white; }
    </style>
</head>
<body>

    <h2>æ·¡æ±Ÿé›»æ©Ÿå€‹äººèª²è¡¨</h2>

    <div class="card" id="auth-section">
        <h3 style="margin-top:0">ğŸ” å¸³è™Ÿç™»å…¥/è¨»å†Š</h3>
        <input type="email" id="email" placeholder="Email (å¸³è™Ÿ)">
        <input type="password" id="pw" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)">
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="primary-btn" style="flex:1" onclick="handleAuth('login')">ç™»å…¥</button>
            <button style="flex:1" onclick="handleAuth('signup')">è¨»å†Š</button>
        </div>
        <p id="user-info" style="font-size: 12px; color: #7f8c8d; margin-top: 10px;"></p>
        <button id="logout-btn" style="display:none; width: 100%; margin-top: 5px;" onclick="handleLogout()">ç™»å‡º</button>
    </div>

    <div class="card">
        <h3 style="margin-top:0">ğŸ” æœå°‹åŒå­¸èª²è¡¨</h3>
        <div style="display: flex; gap: 5px;">
            <input type="email" id="search-email" placeholder="è¼¸å…¥åŒå­¸çš„ Email" style="flex:1">
            <button class="primary-btn" onclick="searchFriend()">æœå°‹</button>
        </div>
    </div>

    <div class="card" style="max-width: 100%; overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>ç¯€æ¬¡</th><th>é€±ä¸€</th><th>é€±äºŒ</th><th>é€±ä¸‰</th><th>é€±å››</th><th>é€±äº”</th>
                </tr>
            </thead>
            <tbody id="timetable-body">
                <tr>
                    <td style="background:#f9f9f9">1</td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
                </tbody>
        </table>
        <button class="success-btn" onclick="saveToCloud()">ğŸ’¾ å„²å­˜èª²è¡¨åˆ°é›²ç«¯</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // è‡ªå‹•å¡«å…¥ä½ æˆªåœ–ä¸­çš„é‡‘é‘°
        const firebaseConfig = {
            apiKey: "AIzaSyDYW7X6O0lPrZRFlBuglb6i1MMVNdkyH1k",
            authDomain: "tkuee-timetable.firebaseapp.com",
            projectId: "tkuee-timetable",
            storageBucket: "tkuee-timetable.firebasestorage.app",
            messagingSenderId: "12075058527",
            appId: "1:12075058527:web:c6a3f9e99a6f7e75bb22ea"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // A. è™•ç†ç™»å…¥èˆ‡è¨»å†Š
        window.handleAuth = async (type) => {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('pw').value;
            if (!email || !pw) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
            try {
                if (type === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, pw);
                    alert("è¨»å†ŠæˆåŠŸï¼");
                } else {
                    await signInWithEmailAndPassword(auth, email, pw);
                    alert("ç™»å…¥æˆåŠŸï¼");
                }
            } catch (e) { alert("éŒ¯èª¤: " + e.message); }
        };

        // B. ç™»å‡º
        window.handleLogout = () => signOut(auth);

        // C. ç›£è½ç™»å…¥ç‹€æ…‹ï¼šç™»å…¥å¾Œè‡ªå‹•æŠ“å–é›²ç«¯èª²è¡¨
        onAuthStateChanged(auth, async (user) => {
            const info = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');
            if (user) {
                info.innerText = "ç›®å‰ç™»å…¥: " + user.email;
                logoutBtn.style.display = "block";
                // å¾ Firestore æŠ“è³‡æ–™
                const docSnap = await getDoc(doc(db, "schedules", user.email));
                if (docSnap.exists()) {
                    document.getElementById('timetable-body').innerHTML = docSnap.data().html;
                }
            } else {
                info.innerText = "å°šæœªç™»å…¥ï¼Œè³‡æ–™å°‡åƒ…å­˜åœ¨æœ¬æ©Ÿ";
                logoutBtn.style.display = "none";
            }
        });

        // D. é›²ç«¯å„²å­˜ï¼šå°‡èª²è¡¨ HTML å­˜é€² Firestore
        window.saveToCloud = async () => {
            if (!auth.currentUser) return alert("è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜åˆ°é›²ç«¯ï¼");
            const tableHTML = document.getElementById('timetable-body').innerHTML;
            await setDoc(doc(db, "schedules", auth.currentUser.email), {
                html: tableHTML,
                updatedAt: new Date()
            });
            alert("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼");
        };

        // E. æœå°‹å¥½å‹åŠŸèƒ½ï¼šè¼¸å…¥ Email æŠ“å–å°æ–¹çš„ HTML
        window.searchFriend = async () => {
            const friendEmail = document.getElementById('search-email').value;
            if (!friendEmail) return alert("è«‹è¼¸å…¥ Email");
            const docSnap = await getDoc(doc(db, "schedules", friendEmail));
            if (docSnap.exists()) {
                document.getElementById('timetable-body').innerHTML = docSnap.data().html;
                alert("ğŸ” æˆåŠŸæŠ“å– " + friendEmail + " çš„èª²è¡¨ï¼");
            } else {
                alert("æ‰¾ä¸åˆ°é€™ä½åŒå­¸çš„èª²è¡¨ï¼Œè«‹ç¢ºèª Email æ˜¯å¦æ­£ç¢ºã€‚");
            }
        };
    </script>
</body>
</html> 
